Title: "[iis]為什麼ssl cipher suite關閉了檢查還是有出現問題 - 如何local檢查ssl和cipher suite"
Published: 2017-11-30
Modified: 2017-11-30
Image: /posts/migrate/2017-11-30-iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test_Asset/image_thumb(52).png
Tags: ["faq","tool","iis"]
RedirectFrom: 2017/11/iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test.html
Series: []
---
<section><figure><a href="https://lh3.googleusercontent.com/-zIxFefLwkvQ/WiAmwU4mjmI/AAAAAAAAW3I/wh0SnylO9T8vh9xXLbfFSgsA-8bmyb9dwCHMYCw/s1600-h/image%255B2%255D"><img width="654" height="290" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test_Asset/image_thumb(52).png" border="0" class="img-responsive"></a><br><figcaption>圖片來源：https://pixabay.com/en/despair-alone-being-alone-archetype-513528/</figcaption></figure></section><section><p>  之前有介紹透過使用IISCrypto來快速設定SSL相關的資安設定。正常來說只要重啟以後禁用的ssl和cipher suite應該就不會出現。   </p><p>  不過如果用一些檢測工具，例如透過<a href="https://www.ssllabs.com/ssltest/">Qualys SSL Lab的SSL ServerTest</a>，那麼有可能還是會<em>看到已經禁用的cipher suite</em>。   </p><p>  這是為什麼呢？這樣到底如何驗證設定是否有成功？這篇將會介紹如何透過local檢測的方式確認修改是否有成功。   </p><div class="bs-callout bs-callout-default"><h4 kmcontenthide="1">相關文章</h4><ul><li><a href="http://blog.alantsai.net/2017/09/iis-security-set-correct-schannel-and-cipher-suite-using-iis-crypto.html" target="_blank" rel="noopener">[iis]每個Server都應該做的資安防護 - 使用IIS Crypto一鍵設定該啟用和停用的SChannel (如SSL 3.0)和Cipher Suite (如MD5)</a><br></li></ul></div></section>   <section> <a name="KMContentPageTopID" id="KMContentPageTopID"></a><div id="divKMOutline" style="border-style: groove none; margin: 10px 0px;"><ul style="margin: 0px 0px 0px 20px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951114" ;="">發生原因</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951620" ;="">解決方式 - 使用TestSSLServer工具做local測試</a><br></li><ul style="margin: 0px 0px 0px 30px;"><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951344" ;="">TestSSLServer工具檔案</a><br></li></ul></ul><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951223" ;="">TestSSLServer的使用方式</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951821" ;="">TestSSLServer cipher suite強度介紹</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1512056126951625" ;="">結語</a><br></li></ul></div></section>   <a name="more"></a><section><h2 id="WizKMOutline_1512056126951114">發生原因</h2><p>  有時候web的機器本身是我們管理，但是整個架構並不是，因此並不知道是不是還有什麼在Server外面，   以我遇到的例子來看，很有可能是在Server外面還有一層Web Application Framework（WAF）導致。   </p><p>  所以就算Server那台透過IISCrypto設定好了，但是假設外面那台沒有設定，那麼當使用網路的服務像是ssl labs的測試，檢測到的其實是<em>外面那台</em>，而不是Server本身。   </p><figure><a href="https://lh3.googleusercontent.com/-PXz4cUfuz8M/WiAmyy1JLvI/AAAAAAAAW3Q/Lz781lHQm-g-T-wcV4ifz5PCCp3sPW-UwCHMYCw/s1600-h/image%255B5%255D"><img width="654" height="361" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test_Asset/image_thumb[1](45).png" border="0" class="img-responsive"></a><br><figcaption>線上測試不通過</figcaption></figure></section><section><h2 id="WizKMOutline_1512056126951620">解決方式 - 使用TestSSLServer工具做local測試</h2><p>  既然不知道Server外面有什麼可能導致線上測試不準確，那麼可以使用工具local直接測試機器是否設定成功。   </p><p>  一開始使用的工具是：<em>nmap</em> - 但是我自己在測試的時候並沒有成功，並且這個需要安裝的東西比較多（都是檢測用的），因此就放棄使用。   </p><p>  最後使用的是：<em>TestSSLServer</em>。   </p><div class="bs-callout bs-callout-info"><h4 id="WizKMOutline_1512056126951344">TestSSLServer工具檔案</h4><ul><li><a href="https://www.bolet.org/TestSSLServer/">官方網站</a></li><li><a href="https://github.com/pornin/TestSSLServer/">Github</a></li><li>直接下載鏈接：<a href="https://www.bolet.org/TestSSLServer/TestSSLServer2.exe">.Net 2.0版本</a>、<a href="https://www.bolet.org/TestSSLServer/TestSSLServer4.exe">.Net 4.0版本</a> <br>(兩個版本執行起來沒有差異，只是看電腦有那.net framework就用那個版本）</li></ul></div></section><section><h2 id="WizKMOutline_1512056126951223">TestSSLServer的使用方式</h2><p>  這個是一個command line的工具，下載下來之後，使用cmd執行即可。   </p><p>  最簡單的使用方式就是輸入：<kbd>TestSSLServer4.exe localhost</kbd></p><figure><a href="https://lh3.googleusercontent.com/-UjMZUEySLVA/WiAm3h2SXEI/AAAAAAAAW3Y/6gnm9Y-UvoYmRtfh3RaRxIk7onSnkLzUQCHMYCw/s1600-h/image%255B8%255D"><img width="573" height="548" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test_Asset/image_thumb[2](38).png" border="0" class="img-responsive"></a><br><figcaption>執行出來的結果</figcaption></figure><p>  從上面的截圖可以看出其實3DES相關的cipher沒有了，但是網路的測試還是又出現。   </p><p>  如果想要把結果儲存起來，可以使用<kbd>TestSSLServer4.exe -text result.txt localhost</kbd> - 這個就是把結果匯出到檔案<code>result.txt</code>。   </p></section><section><h2 id="WizKMOutline_1512056126951821">TestSSLServer cipher suite強度介紹</h2><p>  這個工具其實也可以看出目前允許使用的cipher suite強度如何。   </p><p>  在第一欄（Server）有三個值：   </p><ol><li>第一個值有三種值（<em>0</em>代表非加密，<em>1</em>代表非常弱，<em>2</em>代表弱，<em>3</em>代表強）</li><li>第二個值如果是<em>f</em>表示支援<em>前向安全性(Forward Secrecy)</em>，如果不支援則是<em>-</em></li><li>第三個值如果是<em>A</em>表示anonymous，要不然就是<em>-</em></li></ol><p>  理論上<em>3f-</em>是最強的suite。   </p><figure><a href="https://lh3.googleusercontent.com/-IStF1LsVPO0/WiAm6ka4VPI/AAAAAAAAW3g/HfhBEkLJLasoIldYftVwx4LTJLwX44mewCHMYCw/s1600-h/image%255B11%255D"><img width="582" height="500" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-iis-why-online-test-still-show-disabled-cipher-suite-use-TestSSLServer-for-local-cipher-suite-test_Asset/image_thumb[3](35).png" border="0" class="img-responsive"></a><br><figcaption>機器的檢測結果</figcaption></figure><p>  從截圖裡面可以看出這台的強度都至少在3，因此強度來說應該都沒有問題。   </p></section><section><h2 id="WizKMOutline_1512056126951625">結語</h2><p>  有時候明明設定好了，但是測試不通過的原因是因為<em>被測試的並不是你改的機器</em>，因此用local的工具來測試比較準確。   </p><p>  以這個例子來說，至少有證據表示local看起來設定沒問題，至於線上測試有問題可能就是別的系統（非我們可以控制的部分）導致。   </p></section>    <section>    <div class="wlWriterEditableSmartContent" id="scid:77ECF5F8-D252-44F5-B4EB-D463C5396A79:c25d648d-657d-43be-b708-4a8fed8fc49d" style="margin: 0px; padding: 0px; float: none; display: inline;">標籤: <a href="/tags/iis" rel="tag">iis</a>,<a href="/tags/tool" rel="tag">tool</a>,<a href="/tags/FAQ" rel="tag">FAQ</a></div></section>