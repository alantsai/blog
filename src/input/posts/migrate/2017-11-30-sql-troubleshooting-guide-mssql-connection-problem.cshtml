Title: "[SQL]為什麼連不到MSSQL資料庫 - 故障排除指南"
Published: 2017-11-30
Modified: 2017-12-01
Image: /posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb(51).png
Tags: ["best practices","sql"]
RedirectFrom: 2017/11/sql-troubleshooting-guide-mssql-connection-problem.html
Series: []
---
<section><figure><a href="https://lh3.googleusercontent.com/-Vri5PPU3064/Wh7eklfGoQI/AAAAAAAAW1o/I56Jd3b4yPwaUVllhRgEee0-tf027QjHwCHMYCw/s1600-h/image%255B2%255D"><img width="654" height="290" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb(51).png" border="0" class="img-responsive"></a><br><figcaption>圖片來源：https://pixabay.com/en/key-tag-security-label-symbol-2114047/</figcaption></figure></section><section><p>  任何一個比較大一點的系統都會需要使用到SQL，而以.Net開發為主最長用的資料庫基本上都是MSSQL。   </p><p>  不過MSSQL不一定是我們裝的，因此常遇到的問題就是給的<em>資訊不夠完整</em>，或者<em>裝的時候缺少一些步奏</em>，導致花費很多時間在找出為什麼MSSQL連線不到。   </p><p>  這篇希望提供一個故障排除指南，方便未來如果又連不到的時候可以依照這個項目來排除問題。   </p></section><section>   關鍵字：troubleshooting guide for MSSQL Database connection problem.  </section>    <section> <a name="KMContentPageTopID" id="KMContentPageTopID"></a><div id="divKMOutline" style="border-style: groove none; margin: 10px 0px;"><ul style="margin: 0px 0px 0px 20px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415364" ;="">排除清單 - TL;DR</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415293" ;="">排除問題的詳細步奏</a><br></li><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415203" ;="">檢查服務是否有啟動？</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415437" ;="">確定連線的DB Server Name</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415381" ;="">Network:用local檢查tcp是否有通</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415166" ;="">Network: 用local檢查Database的port</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415579" ;="">用local檢查sql帳號登入是否通過</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415730" ;="">用remote測試連線 - 防火墻</a><br></li></ul><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415313" ;="">結語</a><br></li><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1511971691415874" ;="">參考資料</a><br></li></ul></ul></div></section> <a name="more"></a>  <section><h2 id="WizKMOutline_1511971691415364">排除清單 - TL;DR</h2><p>  以下清單提供一步一步的排除步奏，基本上如果都做完之後連線基本上沒有什麼問題。   </p><div class="table-responsive"><table class="table"><thead><tr><th>       檢查項目      </th><th>       檢查方式      </th><th>       是否通過？      </th></tr></thead><tbody><tr><td>       <a href="#WizKMOutline_1511971691415203">檢查服務是否有啟動？</a>      </td><td>       透過<code>Sql Server Configuration Manager</code> -&gt; <code>Sql Server Services</code> 確認狀態是<em>Running</em>。      </td><td></td></tr><tr><td>       <a href="#WizKMOutline_1511971691415437">確定連線的DB Server Name</a>      </td><td><p>      有兩種Instance名稱：       </p><ol><li>Default Instance - <code>MSSQLSERVER</code> - 連線就是 <code>{computername}</code></li><li>Named Instance - 例如 <code>SQLEXPRESS</code> - 連線就是 <code>{computername}\SQLEXPRESS</code></li></ol></td><td></td></tr><tr><td>       <a href="#WizKMOutline_1511971691415381">用local檢查tcp是否有通</a>      </td><td><p>      使用Sql Server Management Studio（以下簡稱SSMS）連線的時候，在<code>Server Name</code>之前加上<kbd>tcp:</kbd>。       </p><p>      例如：假設Server Name是<code>localhost\SQLEXPRESS</code>，那麼連線就是用<code>tcp:localhost\SQLEXPRESS</code>。       </p><p>      如果連線不到，<code>Sql Server Configuration Manager</code> -&gt; <code>SQL Server Network Configuration</code> - 確定<code>TCP/IP</code>是啟動的       </p></td><td></td></tr><tr><td>       <a href="#WizKMOutline_1511971691415166">用local檢查Database的port</a>      </td><td><p>可以先透過local連線過去（不要用tcp模式），然後檢查log看看目前在聽那個port  如果要調整port可以透過：<code>Sql Server Configuration Manager</code> -&gt; <code>SQL Server Network Configuration</code> -&gt; <code>TCP/IP</code> <kbd>右鍵</kbd> -&gt; <code>內容</code>確認       <code>IP Addresses</code>頁簽裡面最後一項 <code>IP All</code>的<code>TCP Port</code>數字。       </p><p>      如果不是<code>1433</code>，就在<code>DB Server Name</code>後面加上<code>,{port}</code>，例如假設port是50021，那麼整個就是<code>tcp:localhost\SQLEXPRESS,50021</code></p></td><td></td></tr><tr><td>       <a href="#WizKMOutline_1511971691415579">用local檢查sql帳號登入是否通過</a>      </td><td>       有幾個部分可以檢查：       <ol><li>如果出現18456 - 表示沒有開啟<code>Mixed mode</code>（允許sql帳號和windows帳號登入）</li><li>如果出現 預設db 開啟不了 - 檢查這個使用者的權限</li></ol></td><td></td></tr><tr><td>       <a href="#WizKMOutline_1511971691415730">用remote測試連線 - 防火墻</a>      </td><td><p>      使用遠端要連到db的那台測試 - 可以使用<code>.udl</code>檔案來做       </p><p>      注意防火墻設定，要開啟上面找到的port       </p></td><td></td></tr></tbody></table></div></section><section><h2 id="WizKMOutline_1511971691415293">排除問題的詳細步奏</h2><p>  接下來將會對於每一個步奏會有更加詳細的介紹。   </p><section><h3 id="WizKMOutline_1511971691415203">檢查服務是否有啟動？</h3><p>   從<code>開始</code>裡面找到安裝的SQL Server版本，展開之後選擇<code>Configuration Tools</code> -&gt;<code>Sql Server Configuration Manager</code></p><figure><a href="https://lh3.googleusercontent.com/-Rm3hVTlbP6s/Wh7em_X7vkI/AAAAAAAAW1w/wzsXel8StjkmQr9R1xYt_CDPud_zpdLKACHMYCw/s1600-h/image%255B5%255D"><img width="267" height="501" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[1](44).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>開啟Sql Server Configuration Manager</figcaption></figure><p>   從左邊選取<code>SQL Server Services</code>，然後檢查右邊<code>SQL Server</code>的狀態處於<code>Running</code>。    </p><figure><a href="https://lh3.googleusercontent.com/-Q6ui-4bT4oY/Wh7eo_Q9ogI/AAAAAAAAW14/X-NcR8Vp_gQJ_poNLLJekaHY3OojHrYYwCHMYCw/s1600-h/image%255B8%255D"><img width="654" height="120" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[2](37).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>確認Sqlexpress這個instance狀態處於Running</figcaption></figure></section><section><h3 id="WizKMOutline_1511971691415437">確定連線的DB Server Name</h3><p>   需要先確認DB的Instance名稱。    </p><p>   從上一個步奏確認服務是否有啟動的部分，可以看到在括弧裡面的就是DB的Instance名稱。以剛剛那個為例子，就是<code>SQLEXPRESS</code>。    </p><p>   Instance名稱有分為2種：    </p><ol><li>Default Instance - <em>MSSQLSERVER</em> 是Default Instance</li><li>Named Instance - 其他設定都是Named Instance</li></ol><p>   如果是<em>Default Instance</em>，那麼連線的DB Server Name就是<code>{電腦名稱}</code>，如果是<em>Named Instance</em>，那麼就是<code>{電腦名稱}\{Instance名稱}</code></p><p>   以剛剛那個instance為例，因為它是Named Instance，因此它的Server Name是<code>localhost\SQLEXPRESS</code></p><figure><a href="https://lh3.googleusercontent.com/-ZgkGZAJK3e0/Wh7erd0nDGI/AAAAAAAAW2A/3gGIrdDlNYAuhz5dOmNzXl9p1_BEQnu_QCHMYCw/s1600-h/image%255B11%255D"><img width="430" height="387" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[3](34).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>測試的連線畫面</figcaption></figure></section><section><h3 id="WizKMOutline_1511971691415381">Network:用local檢查tcp是否有通</h3><p>   當上面步奏連線成功的時候，走的是<em>Shared Memory</em>的通道，因此<em>不表示tcp連線</em>（因為從另外一台連過來走的通道）是可以通。    </p><p>   為了避免其他network的問題，可以先在local（DB在的那台）測試tcp通道是否有問題。    </p><p>   做法很簡單，就是把上一步取得的DB Server Name的前面加上<code>tcp:</code>即可，因此最後的結果是：<code>tcp:localhost\SQLEXPRESS</code></p><figure><a href="https://lh3.googleusercontent.com/-5ASKlvE1pZY/Wh7euxKf75I/AAAAAAAAW2I/N1UIbnaSKsMMVcmdQ89X-bLZeEyPoV9MgCHMYCw/s1600-h/image%255B14%255D"><img width="416" height="237" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[4](34).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>測試tcp連線的畫面</figcaption></figure><p>   如果連線失敗，用<code>Sql Server Configuration Manager</code> -&gt; <code>Sql Server Network Configuration</code> 裡面的 <code>Protocols for {instance name}</code></p><p>   確定<code>TCP/IP</code>處於<code>Enabled</code>的狀態。    </p><figure><a href="https://lh3.googleusercontent.com/-4CGVDI6gO3g/Wh7eyXYRElI/AAAAAAAAW2Q/WQbhK8GAZCoZ5c5ddnvFJuMvpoMeJV_twCHMYCw/s1600-h/image%255B17%255D"><img width="550" height="275" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[5](25).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>確認TCP/IP是啟用的狀態</figcaption></figure></section><section><h3 id="WizKMOutline_1511971691415166">Network: 用local檢查Database的port</h3><p>   如果上一個步奏<code>TCP/IP</code>已經是<code>Enabled</code>的情況但是還是連不到，檢查一下port是否正確。    </p><p>   預設port是<code>1433</code>，如果DB不在預設port，那麼連線的時候需要打上port號。    </p><p>			先用local的方式連到DB（不要加上tcp的部分）去檢查log看看目前在聽那個port： 			</p><figure><a href="https://lh3.googleusercontent.com/-c1Hr5pA5ME0/WiAw54c_YpI/AAAAAAAAW30/UWfnS-dgdTs5FK7Y2-hozhVA2HiBldJAQCHMYCw/s1600-h/image%255B3%255D"><img width="654" height="459" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[1](46).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>檢查步奏</figcaption></figure><ol><li>選擇<code>Management</code></li><li>選擇<code>SQL Server Log</code></li><li>選擇最新的一筆</li><li>從跳出的畫面選擇<code>Filter</code></li><li>在<code>Message Contains Text</code>輸入：server is listening on</li><li>勾起來<code>Apply Filter</code></li><li>選擇ok</li><li>檢查結果，可以看到這個聽的port是50021</li></ol><p>			修改port號可以透過<code>Sql Server Configuration Manager</code> 工具的：    </p><ol><li><code>Sql Server Network Configuration</code> -&gt; <code>Protocols for {instance name}</code></li><li>對<code>TCP/IP</code>點<kbd>右鍵</kbd>然後選擇<code>內容</code></li><li>切換到頁簽<code>IP Address</code>，並且卷到做下面，檢查<code>IP All</code>的TCP port是不是1433。</li></ol><figure><a href="https://lh3.googleusercontent.com/-fWktlreWAzg/Wh7e2H6icaI/AAAAAAAAW2Y/w2f0lpUjuO4s2VlaRYXs7s1ugmjSJHyIgCHMYCw/s1600-h/image%255B20%255D"><img width="654" height="342" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[6](22).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>檢查port的方式</figcaption></figure><div class="bs-callout bs-callout-info">    如果有改TCP Port，記得要重啟DB Service才會有作用。    </div><div class="bs-callout bs-callout-info">    假設port有修改，連線的時候在後面加上<code>,{port號}</code>即可使用哪個port做連線。例如假設port號是<code>50021</code>，那麼連線就是：<code>tcp:localhost\SQLEXPRESS,50021</code><figure><a href="https://lh3.googleusercontent.com/-QdpBXvP9ZM8/Wh7e8w5nrBI/AAAAAAAAW2g/Z5S1DiW8oAQIwEdBEcMALioUJQNJf_zCQCHMYCw/s1600-h/image%255B23%255D"><img width="422" height="191" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[7](16).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>連線畫面</figcaption></figure></div></section><section><h3 id="WizKMOutline_1511971691415579">用local檢查sql帳號登入是否通過</h3><p>   一般來說連線的時候都是使用Sql帳號（而不是Windows驗證），因此要用local測試使用Sql帳號是否能夠登入。    </p><p>   假設出現了登入錯誤，Sql Error 18456，表示沒有開啟<code>Mixed Mode</code>，解決方式：    </p><ol><li>先用Windows驗證連到DB並且對DB點<kbd>右鍵</kbd>，選擇<code>Properties</code></li><li>切換到<code>Security</code>的左邊menu</li><li>選擇<code>Sql Server and Windows Authentication Mode</code> - 並且記得<em>重啟DB的Service</em></li></ol><figure><a href="https://lh3.googleusercontent.com/-o6ecWsWaCWM/Wh7fA9zbGwI/AAAAAAAAW2o/B-KzQs8-OZciYAHrlIgHArijMDSkMk4MQCHMYCw/s1600-h/image%255B26%255D"><img width="654" height="354" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-11-30-sql-troubleshooting-guide-mssql-connection-problem_Asset/image_thumb[8](16).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>設定畫面</figcaption></figure></section><section><h3 id="WizKMOutline_1511971691415730">用remote測試連線 - 防火墻</h3><p>   基本上如果上面都做完，基本上連線就不會有什麼問題，剩下可能會擋的部分就剩下防火墻。    </p><p>   可以先嘗試把DB那台和需要連到DB的那台的防火墻<em>先關掉</em>做測試，如果可以連，在把它打開，然後設定允許DB的port連線。    </p><div class="bs-callout bs-callout-info"><p>    如果AP那台沒有連線工具可以連到DB做測試，那麼可以建立<code>udl</code>檔案做連線測試。     </p><p>    詳細做法可以參考：<a href="https://dotblogs.com.tw/alantsai/2013/12/04/testdbconnection">使用udl檔案測試DB連線是否成功</a></p></div></section></section><section><h2 id="WizKMOutline_1511971691415313">結語</h2><p>  DB連線不到的問題可能牽扯到很多不同部分的設定，因此希望透過這一篇提供的一步一步排除步奏能夠在未來如果遇到連線不到的情況能夠快速找到問題。   </p></section><section><h3 id="WizKMOutline_1511971691415874">參考資料</h3><dl><dt>     官方的troubleshooting guide    </dt><dd><a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/troubleshoot-connecting-to-the-sql-server-database-engine">Troubleshoot Connecting to the SQL Server Database Engine</a></dd><dd></dd><dt>     介紹設定防火墻    </dt><dd><a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access">Configure a Windows Firewall for Database Engine Accessä</a></dd><dd></dd><dt>     另外一個的troubleshooting guide    </dt><dd><a href="https://blogs.msdn.microsoft.com/sql_protocols/2008/04/30/steps-to-troubleshoot-sql-connectivity-issues/">Steps to troubleshoot SQL connectivity issues</a></dd><dd></dd></dl></section> <section> <div class="wlWriterEditableSmartContent" id="scid:77ECF5F8-D252-44F5-B4EB-D463C5396A79:155fdce1-321a-49f1-acd6-03f61f587ccd" style="margin: 0px; padding: 0px; float: none; display: inline;">標籤: <a href="/tags/best+practices" rel="tag">best practices</a>,<a href="/tags/sql" rel="tag">sql</a></div></section>