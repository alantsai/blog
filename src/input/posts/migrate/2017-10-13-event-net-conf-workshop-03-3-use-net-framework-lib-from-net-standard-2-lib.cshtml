Title: "[.Net Core 與 .Net Standard 實戰教學][Lab][03-3].Net Standard 2.0能夠直接Reference .Net Framework Library"
Published: 2017-10-13 23:00
Modified: 2017-10-13 23:00
Image: /posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb(45).png
Tags: ["net-standard","lab","「.net core 與 .net standard 實戰教學」","net-core"]
RedirectFrom: 2017/10/event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib.html
Series: ["「.Net Core 與 .Net Standard 實戰教學」"]
---
<section><figure><a href="https://lh3.googleusercontent.com/-WZ_-oZFJ2cM/WeCzcZhAm6I/AAAAAAAAWng/ZK5XZmEI82IWFPRGCoPavarAlHEznqn2ACHMYCw/s1600-h/image%255B2%255D"><img width="654" height="290" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb(45).png" border="0" class="img-responsive"></a><br><figcaption>圖片來源：https://pixabay.com/en/workshop-rustic-hammer-wrench-tool-2608390/</figcaption></figure></section><section><p>  透過上一個lab： 了解到了如何更容易評估把.net framework程式碼port到.net Standard之後，接下來的問題就是，可是有些第三方.net framework library<em>沒有</em>source code但是<em>又要用</em>怎麼辦？   </p><p>  在這個lab將會介紹.Net Standard 2.0帶來的一大優勢，能夠直接reference .net framework的library。將會使用一個2012的library：<code>NQuery</code>，主要目的是可以用sql語法來查詢資料。將會調整改成這種方式來查資料。   </p><div class="bs-callout bs-callout-default"><p>    上個lab的最後成果的程式碼可以再github看到：<a href="https://github.com/alantsai-samples/2017-10-14-net-core-workshop">https://github.com/alantsai-samples/2017-10-14-net-core-workshop</a></p><p>    git標籤：<code>lab3/1-port-net-standard-finish</code></p><p>    兩種方式取得：     </p><ol><li>用git clone然後在checkout到<code>lab3/1-port-net-standard-finish</code></li><li>從github release下載：<a href="https://github.com/alantsai-samples/2017-10-14-net-core-workshop/releases/tag/lab3%2F1-port-net-standard-finish">下載鏈接</a></li></ol></div></section>     <section>     <a name="KMContentPageTopID" id="KMContentPageTopID"></a><div id="divKMOutline" style="border-style: groove none; margin: 10px 0px;"><ul style="margin: 0px 0px 0px 20px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1507897775595875" ;="">操作步驟</a><br></li><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1507897775596521" ;="">修改Net Standard Library使用NQuery</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1507897775596281" ;="">測試net core console結果</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1507897775596601" ;="">測試WinForm</a><br></li></ul></ul></div><section>     <a name="more"></a><section><h2 id="WizKMOutline_1507897775595875">操作步驟</h2><ol><li>修改Net Standard Library使用NQuery</li><li>測試net core console結果</li><li>測試WinForm</li></ol><section><h3 id="WizKMOutline_1507897775596521">修改Net Standard Library使用NQuery</h3><dl><dt>      以NQuery這個套件為例子，最後更新是2012年 肯定不是.net core     </dt><dd><a href="https://www.nuget.org/packages/NQuery/">https://www.nuget.org/packages/NQuery/</a><figure><a href="https://lh3.googleusercontent.com/-HFqPEhNcdVk/WeCzndX7dQI/AAAAAAAAWno/QLmtEIIlb5Yqz_IxbMkmpWXURXveIuc9wCHMYCw/s1600-h/image%255B5%255D"><img width="654" height="372" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[1](39).png" border="0" class="img-responsive"></a></figure></dd><dd></dd><dt>      準備加入Nquery     </dt><dd><ol><li>對 <code>NorthwindDalNetStandard</code>點<kbd>右鍵</kbd></li><li>選擇<code>Manage Nuget Package..</code></li><li>搜索<code>NQuery</code></li><li>安裝</li></ol><figure><a href="https://lh3.googleusercontent.com/-640gGImj7LQ/WeCzs3UGbFI/AAAAAAAAWnw/dnNYzXhQTpIqZMLh3hrvzB6S8C0Vrbk3QCHMYCw/s1600-h/image%255B8%255D"><img width="654" height="189" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[2](33).png" border="0" class="img-responsive"></a></figure></dd><dd></dd><dt>      調整 <code>NorthwindDalNetStandard.NorthwindDal.cs</code>的<code>GetEmployeeFromCountry</code>方法內容，改成用<code>NQuery</code>來過濾     </dt><dd>      改成以下程式碼： <pre class="brush: csharp;"><code class="language-csharp line-numbers">public static string GetEmployeeFromCountry(string filterCountry = "UK")
{
 DataSet dataSet = new DataSet();
 dataSet.ReadXml("northwind.xml");

 var dataContext = new DataContext();
 dataContext.AddTablesAndRelations(dataSet);

 var sql = @@"
  SELECT  e.FirstName + ' ' + e.LastName
  FROM    Employees e
  WHERE   e.Country = '" + filterCountry + "'";

 var query = new Query(sql, dataContext);
 var results = query.ExecuteDataTable();
 var values = results.Rows.Cast&lt;DataRow&gt;().Select(r =&gt; (string)r[0]);
 var result = string.Join(Environment.NewLine, values);

 return result;
}</code></pre></dd><dd></dd></dl></section><section><h3 id="WizKMOutline_1507897775596281">測試net core console結果</h3><dl><dt>      build專案，並且用dotnet執行     </dt><dd>      用<code>cmd</code>執行：<code>dotnet NetCoreConsole.dll</code><figure><a href="https://lh3.googleusercontent.com/-5iohtkEZu9s/WeCzzu5MhRI/AAAAAAAAWn4/ny5MajQKVfwDc0xShwcwOZ1fnBpjHl6xQCHMYCw/s1600-h/image%255B11%255D"><img width="654" height="103" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[3](30).png" border="0" class="img-responsive"></a></figure></dd><dd></dd></dl><p>   執行結果和未修改前一致，換句話說使用沒有問題    </p></section><section><h3 id="WizKMOutline_1507897775596601">測試WinForm</h3><dl><dt>      如果用 WinForm來執行會出錯     </dt><dd><p>     會出現說 Nquery 這個 dll 找不到      </p><pre class="brush: plain;"><code class="language-none line-numbers">System.IO.FileNotFoundException: Could not load file or assembly 
'NQuery, Version=0.9.5.0, Culture=neutral, PublicKeyToken=c65c4087e4cc0612' 
or one of its dependencies. The system cannot find the file specified.
     </code></pre><figure><a href="https://lh3.googleusercontent.com/-oKF4459O3Wk/WeCz5CZqhPI/AAAAAAAAWoA/TvdoIXrQIroPbK05AsAJ5ddVeB5OOpAnwCHMYCw/s1600-h/image%255B14%255D"><img width="654" height="297" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[4](29).png" border="0" class="img-responsive"></a></figure></dd><dd></dd><dt>     這個是一個已知的bug，只有以前的程式（.Net Framework）的會發生，需要手動改csproj     </dt><dd>      先對<code>LegacyApplication.View</code>點<kbd>右鍵</kbd>然後選擇<code>Unload Project</code><figure><a href="https://lh3.googleusercontent.com/-PkDuRC_Io24/WeCz_BQ301I/AAAAAAAAWoM/A0aHV1nz_VQ6EIASJ0MOhrlH9_6TMrShACHMYCw/s1600-h/image%255B20%255D"><img width="654" height="419" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[6](19).png" border="0" class="img-responsive"></a></figure><div class="bs-callout bs-callout-warning">      這個bug目前沒有任何預計解決辦法，只有改csproj檔案而已。相關issue請看：<a href="https://github.com/dotnet/sdk/issues/901">https://github.com/dotnet/sdk/issues/901</a></div></dd><dd></dd><dt>      在來對csproj做修改     </dt><dd><ol><li>對<code>LegacyApplication.View</code>點<kbd>右鍵</kbd>，然後選擇 <code>Edit LegacyApplication.View.csproj</code></li><li>加入<code>&lt;RestoreProjectStyle&gt;PackageReference&lt;/RestoreProjectStyle&gt;</code></li><li>確定也有&lt;AutoGenerateBindingRedirects&gt;true&lt;/AutoGenerateBindingRedirects&gt;</li><li>好了 之後 <code>Reload Project</code></li></ol><figure><a href="https://lh3.googleusercontent.com/-kEOuJ2CkBE0/WeC0LW45LLI/AAAAAAAAWoY/x6Z5wUio4vsvovAng_WpGi6JfM4Ixm_bwCHMYCw/s1600-h/image%255B23%255D"><img width="654" height="209" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[7](14).png" border="0" class="img-responsive"></a></figure></dd><dd></dd><dt>       設定 為起始專案 之後嘗試執行     </dt><dd><figure><a href="https://lh3.googleusercontent.com/-4Vg5PM7__Fc/WeC0Py3ULoI/AAAAAAAAWog/2Pzz7_56f2ASZegqaW-9dG96i1-91JxnwCHMYCw/s1600-h/image%255B26%255D"><img width="654" height="431" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="/posts/migrate/2017-10-13-event-net-conf-workshop-03-3-use-net-framework-lib-from-net-standard-2-lib_Asset/image_thumb[8](14).png" border="0" class="img-responsive"></a></figure></dd><dd></dd></dl></section><p>  透過以上方式，據說<em>70%</em>的nuget net Framework api net standard 2.0 都能夠支援，換句話說能夠減少整合成本。   </p><div class="bs-callout bs-callout-info">   雖然說.Net standard 2.0可以直接reference，但是如果是可以控制的lib，建議還是統一改成net standard，更容易和未來接軌。   </div><div class="bs-callout bs-callout-default"><p>    完整程式碼可以再github看到：<a href="https://github.com/alantsai-samples/2017-10-14-net-core-workshop">https://github.com/alantsai-samples/2017-10-14-net-core-workshop</a></p><p>    git標籤：<code>lab3/3-use-net-framework-lib-finish</code></p><p>    兩種方式取得：     </p><ol><li>用git clone然後在checkout到<code>lab3/3-use-net-framework-lib-finish</code></li><li>從github release下載：<a href="https://github.com/alantsai-samples/2017-10-14-net-core-workshop/releases/tag/lab3%2F3-use-net-framework-lib-finish">下載鏈接</a></li></ol></div></section><section>   <div class="wlWriterEditableSmartContent" id="scid:77ECF5F8-D252-44F5-B4EB-D463C5396A79:b73daaf7-7a90-4368-9fc5-71d5ed3f267e" style="margin: 0px; padding: 0px; float: none; display: inline;">標籤: <a href="/tags/%e3%80%8c.Net+Core+%e8%88%87+.Net+Standard+%e5%af%a6%e6%88%b0%e6%95%99%e5%ad%b8%e3%80%8d" rel="tag">「.Net Core 與 .Net Standard 實戰教學」</a>,<a href="/tags/lab" rel="tag">lab</a>,<a href="/tags/net-core" rel="tag">net-core</a>,<a href="/tags/net-standard" rel="tag">net-standard</a></div></section></section></section>