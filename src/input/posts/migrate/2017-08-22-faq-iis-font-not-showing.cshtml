Title: "IIS 無法取得font - 錯誤 Failed to decode downloaded font - 了解MIME設定和gitattributes錯誤導致的問題"
Published: 2017-08-22
Modified: 2017-08-24
Image: /posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb(23).png
Tags: ["faq","git","iis"]
RedirectFrom: 2017/08/faq-iis-font-not-showing.html
Series: []
---
<section><figure><a href="https://lh3.googleusercontent.com/-8TpADWT6OmQ/WZtxfeb43ZI/AAAAAAAAWH8/_g9poanEVm4CbvsrkgNGEmAfMe9gMWqlACHMYCw/s1600-h/image%255B2%255D"><img width="654" height="290" title="IIS 無法取得font - 錯誤 Failed to decode downloaded font - 了解MIME設定和gitattributes錯誤導致的問題" style="display: inline; background-image: none;" alt="IIS 無法取得font - 錯誤 Failed to decode downloaded font - 了解MIME設定和gitattributes錯誤導致的問題" src="/posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb(23).png" border="0" class="img-responsive"></a><br><figcaption>圖片來源：https://pixabay.com/en/despair-alone-being-alone-archetype-513528/</figcaption></figure><p>最近在案子裡面遇到網站有使用到<a href="http://fontello.com/">Fontello</a>的元件。網站的靜態切板沒什麼問題但是掛到了iis之後，發現icon的部分<em><strong>都出不來</strong></em>，然後chrome F12的developer工具出現了錯誤訊息：   </p><div class="bs-callout bs-callout-warning"><figure><a href="https://lh3.googleusercontent.com/-1tcOkAXFX0Y/WZtxiRgeLBI/AAAAAAAAWIE/y7C8_zs7_BYWNa2XEUur4IoUtPP5ZdfDgCHMYCw/s1600-h/image%255B5%255D"><img width="654" height="396" title="Failed to decode downloaded font" style="display: inline; background-image: none;" alt="Failed to decode downloaded font" src="/posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb[1](21).png" border="0" class="img-responsive"></a><br><figcaption><p>Failed to decode downloaded font</p><p>OTS parsing error: incorrect file size in WOFF header     </p></figcaption></figure><figure><a href="https://lh3.googleusercontent.com/-EgbvhY-tMlA/WZtxkrt5IFI/AAAAAAAAWIM/FVk0_OFdIU0K9oeE8_3-q9b4kUazlUgBACHMYCw/s1600-h/image%255B8%255D"><img width="654" height="258" title="但是看network裡面fontello的font又有load成功" style="display: inline; background-image: none;" alt="但是看network裡面fontello的font又有load成功" src="/posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb[2](15).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>但是看<code>network</code>裡面fontello的font又有load成功</figcaption></figure></div><p>這不是我第一次使用這種font相關的套件，為什麼以前沒有發生呢？這篇將會對於發生的原因和解決方式做個總結。   </p></section><section>    關鍵字：fontello出不來、fontawesome出不來、無法使用font套件   </section>   <section> <a name="KMContentPageTopID" id="KMContentPageTopID"></a><div id="divKMOutline" style="border-style: groove none; margin: 10px 0px;"><ul style="margin: 0px 0px 0px 20px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233239" ;="">解決方式 - TL;DR</a><br></li><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233944" ;="">IIS需要設定font附件的MIME類型</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233843" ;="">注意font的line ending是不是被改動了</a><br></li></ul><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233823" ;="">問題發生原因</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233147" ;="">了解MIME設定</a><br></li><ul style="margin: 0px 0px 0px 30px;"><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233505" ;="">MIME目的是什麼？</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233907" ;="">MIME的全稱和格式</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233281" ;="">MIME和web（http）的關係</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233262" ;="">這個和我們問題有什麼關係？</a><br></li></ul><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233667" ;="">git line ending問題</a><br></li><li><a style="line-height: 1.6; font-size: 15px;" href="#WizKMOutline_1503358811233442" ;="">結語</a><br></li></ul></div></section>   <a name="more"></a>   <section><h2 id="WizKMOutline_1503358811233239">解決方式 - TL;DR</h2><p>其實這個問題有兩個部分：   </p><ol><li>IIS需要設定font附件的MIME類型，要不然瀏覽器會識別不出來</li><li>注意font的line ending是不是被改動了 - 假設使用git做版控然後line ending沒處理好，非常有可能發生</li></ol><section><h3 id="WizKMOutline_1503358811233944">IIS需要設定font附件的MIME類型</h3><p>設定方式很簡單，只需要在網站裡面的<code>Web.config</code>的<code>system.webServer</code> &gt; <code>staticContent</code> 加入以下即可：   </p><pre class="brush: xml;"><code class="language-markup line-numbers"><system.webserver>
 <staticcontent>
  <mimemap fileextension=".eot" mimetype="application/vnd.ms-fontobject">
  <remove fileextension=".ttf">
  <mimemap fileextension=".ttf" mimetype="application/x-font-ttf">
  <remove fileextension=".woff">
  <mimemap fileextension=".woff" mimetype="application/font-woff">
  <remove fileextension=".woff2">
  <mimemap fileextension=".woff2" mimetype="application/font-woff2">
 </mimemap></remove></mimemap></remove></mimemap></remove></mimemap></staticcontent>
</system.webserver></code></pre></section><section><h3 id="WizKMOutline_1503358811233843">注意font的line ending是不是被改動了</h3><p>假設是Windows，那麼如果你的<code>.gitattribute</code>沒有設定好的話，那麼很有可能你的font line ending已經被改掉了，這會造成chrome無法parsing。    </p><p>解決方式是做個斷行一致化處理，詳細可以參考：<a href="http://blog.alantsai.net/2017/07/git-normalize-line-ending.html">[git]為什麼常出現有修改但是比對不卻顯示不出差異？談談檔案斷行問題和如何達到不同平台正確一致化</a>，基本要做的動作如下：    </p><dl><dt>      先為專案設定<code>.gitattribute</code></dt><dd><a href="https://github.com/alantsai/mhat-common-boilerplate-repo/blob/master/.gitattributes">可以使用我另外一篇介紹的gitattribute做開始</a></dd><dd></dd><dt>                     假設有任何修改尚未commit，先commit                 </dt><dd><code>git commit -am "儲存目前修改"</code></dd><dt>                         把所有檔案刪掉（不包含.git）                 </dt><dd><code>                            git rm --cached -r .                         </code></dd><dt>                         重新從repo把刪除的修改revert掉                 </dt><dd><code>git reset .</code></dd><dt>                     加入index                 </dt><dd><code>git add -u</code> - 如果有看到很多warning提示會從crlf轉成lf是正常的。                 </dd><dt>                     commit上去                 </dt><dd><code>git commit -m "斷行一致化處理"</code></dd></dl></section></section><section><h2 id="WizKMOutline_1503358811233823">問題發生原因</h2><p>從上面的解決方式有2個步奏不難發現，其實這個問題有兩個部分：   </p><ol><li>IIS MIME設定問題</li><li>git line ending 問題</li></ol></section><section><h2 id="WizKMOutline_1503358811233147">了解MIME設定</h2><section><h3 id="WizKMOutline_1503358811233505">MIME目的是什麼？</h3><p>大家有沒有想過，這世界上格式那麼多，當收到一個檔案，例如pdf，電腦怎麼知道這是一個pdf？   </p><p>如果是windows出生可能會想說靠副檔名啊，有什麼難的，但是副檔名是可以自己亂改，那麼系統收到一個檔案的時候怎麼知道這是什麼檔案呢？ </p><p>這個就是MIME的作用。   </p></section><section><h3 id="WizKMOutline_1503358811233907">MIME的全稱和格式</h3><p>MIME的全稱是<code>Multipurpose Internet Mail Extensions</code>本來主要的使用地方是在表示寄送的<em><strong>email內容和附件的格式內容</strong></em>。   </p><p>MIME的格式是<code>{大類}/{小類}</code> - 例如<code>video/mp4</code>或者<code>application/pdf</code>。   </p></section><section><h3 id="WizKMOutline_1503358811233281">MIME和web（http）的關係</h3><p>既然上面說了MIME主要用於email那麼和web有什麼關係？在http裡面其實也會遇到和email一樣問題，不過有兩個情況：   </p><dl><dt>     browser可能想要和server取得某種類型格式的資料    </dt><dd>      http header<code>Accept</code>用來做這個事情 - 值則是使用MIME的值    </dd><dd></dd><dt>     server告訴browser目前傳遞的是什麼類型的資料 </dt><dd>     http header <code>Content-Type</code> 用來做這個事情 - 值則是使用MIME的值    </dd><dd></dd></dl>所以可以發現http基本上是用了MIME的格式在定義傳輸和要求的資料要是什麼格式。   </section><section><h3 id="WizKMOutline_1503358811233262">這個和我們問題有什麼關係？</h3><p>由於IIS預設並不會設定font相關的MIME，這個造成了當瀏覽器收到的時候，<em><strong>不知道這個是什麼類型檔案，因此不知道如何處理</strong></em>。    </p><p>所以雖然我們在chrome的network看得到font資訊，但是因為缺少mime，browser無法處理造成讀取失敗。因此出現了錯誤訊息：    </p><div class="bs-callout bs-callout-warning">Failed to decode downloaded font    </div></section></section><section><h2 id="WizKMOutline_1503358811233667">git line ending問題</h2><p>git line ending問題在另外一篇<a href="http://blog.alantsai.net/2017/07/git-normalize-line-ending.html">[git]為什麼常出現有修改但是比對不卻顯示不出差異？談談檔案斷行問題和如何達到不同平台正確一致化</a>已經有詳細說明了，因此這篇不再贅述實際解決方式，不過對於實際錯誤問題做一點說明。   </p><p>下面的截圖可以看到<code>content-type</code>對了，但是line ending其實錯了，所以還是出現不了，只需要做完line ending一致化就好了。   </p><a href="https://lh3.googleusercontent.com/-Hjb65Ijv0Ew/WZtxn_BWQDI/AAAAAAAAWIU/eP1BDIxELp4FIrPWEO-9zR95nVbXsYWkACHMYCw/s1600-h/image%255B11%255D"><img width="654" height="389" title="content-type對了" style="display: inline; background-image: none;" alt="content-type對了" src="/posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb[3](12).png" border="0" class="img-responsive"></a><figure><a href="https://lh3.googleusercontent.com/-XmURTUNZgWU/WZtxsG0ZMzI/AAAAAAAAWIc/phxFMhSeWiUPBkz5O9VZD2ito84YkDx-gCHMYCw/s1600-h/image%255B17%255D"><img width="654" height="226" title="line ending還沒有解決" style="display: inline; background-image: none;" alt="line ending還沒有解決" src="/posts/migrate/2017-08-22-faq-iis-font-not-showing_Asset/image_thumb[5](6).png" border="0" class="img-responsive"></a>&nbsp;&nbsp;&nbsp; <br><figcaption>第一張圖可以看到mime問題解決，但是和git比對的時候發現line ending還沒有解決(第二張圖是對)所以還是有問題，一致化之後就好了</figcaption></figure></section><section><h2 id="WizKMOutline_1503358811233442">結語</h2><p>在開篇的時候我有提到，其實我用過很多次這種font的Library，為什麼以前都沒問題？我事後想了一下，非常有可能之前用的都是cdn的服務，因此cdn設定好了所以沒有問題。   </p><p>這個告訴我，其實有很多細節別的系統可能都處理好了，但是如果個人基本功不好，其實很容易花時間在這種小細節上面。   </p><p>希望透過這篇能夠再次說明git line ending的問題和了解mime對於http的重要性。   </p></section>